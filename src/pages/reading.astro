---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Hr from "@/components/Hr.astro";

const title = "Reading List";
const description = "Things I've read and things I want to read.";
---

<Layout title={title} description={description}>
  <Header activeNav="reading" />
  <main id="main-content" class="mx-auto w-full max-w-3xl px-4 pb-12">
    <section class="prose prose-lg prose-neutral dark:prose-invert max-w-none">
      <h1 class="text-2xl font-bold tracking-tight sm:text-3xl">Reading List</h1>
      <p class="text-skin-base">
        A living collection of articles, essays, and books that have shaped my thinking â€” and those I'm planning to dive into next.
      </p>
      
      <Hr />
      
      <div id="reading-lists" class="space-y-12">
        <div class="flex justify-center items-center py-8">
          <p class="text-skin-base">Loading...</p>
        </div>
      </div>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  interface ReadingItem {
    title: string;
    url: string;
    date?: string;
    dateAdded?: string;
  }

  interface ReadingData {
    read: ReadingItem[];
    toRead: ReadingItem[];
  }

  async function loadReadingList() {
    try {
      const response = await fetch('/data/reading.json');
      const data: ReadingData = await response.json();
      
      const container = document.getElementById('reading-lists');
      if (!container) return;

      // Sort read items by date (newest first)
      const readItems = [...data.read].sort((a, b) => {
        if (!a.date || !b.date) return 0;
        return new Date(b.date).getTime() - new Date(a.date).getTime();
      });

      // Sort to-read items by dateAdded (newest first)
      const toReadItems = [...data.toRead].sort((a, b) => {
        if (!a.dateAdded || !b.dateAdded) return 0;
        return new Date(b.dateAdded).getTime() - new Date(a.dateAdded).getTime();
      });

      const formatDate = (dateStr: string) => {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      };

      const renderList = (items: ReadingItem[], dateKey: 'date' | 'dateAdded') => {
        return items.map(item => {
          const dateValue = item[dateKey];
          const dateDisplay = dateValue ? formatDate(dateValue) : '';
          
          return `
            <li class="flex justify-between items-baseline gap-4 py-2">
              <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="text-skin-accent hover:underline flex-grow">
                ${item.title}
              </a>
              ${dateDisplay ? `<span class="text-sm text-skin-base opacity-70 whitespace-nowrap">${dateDisplay}</span>` : ''}
            </li>
          `;
        }).join('');
      };

      container.innerHTML = `
        <section>
          <h2 class="text-xl font-semibold mb-4">Things I've Read</h2>
          ${readItems.length > 0 ? `<ul class="space-y-1">${renderList(readItems, 'date')}</ul>` : '<p class="text-skin-base opacity-70">Nothing here yet.</p>'}
        </section>
        
        <section>
          <h2 class="text-xl font-semibold mb-4">Things I Want to Read</h2>
          ${toReadItems.length > 0 ? `<ul class="space-y-1">${renderList(toReadItems, 'dateAdded')}</ul>` : '<p class="text-skin-base opacity-70">Nothing here yet.</p>'}
        </section>
      `;
    } catch (error) {
      console.error('Failed to load reading list:', error);
      const container = document.getElementById('reading-lists');
      if (container) {
        container.innerHTML = '<p class="text-red-500">Failed to load reading list.</p>';
      }
    }
  }

  // Load on page load
  loadReadingList();
</script>
